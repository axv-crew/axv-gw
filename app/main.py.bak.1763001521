from fastapi import FastAPI

from app.routers import front, hooks, internal

# == optional middleware imports (fallbacks) ==
try:
    from app.middleware import RequestLoggingMiddleware
except Exception:
    RequestLoggingMiddleware = None

try:
    from axv_gw.middleware.rate_limit import RateLimitMiddleware
except Exception:
    try:
        from app.middleware.rate_limit import RateLimitMiddleware
    except Exception:
        RateLimitMiddleware = None

try:
    from axv_gw.middleware.hmac_ts import HMACTimestampGuard
except Exception:
    try:
        from app.middleware.hmac_ts import HMACTimestampGuard
    except Exception:
        HMACTimestampGuard = None

try:
    from axv_gw.middleware.size_guard import SizeGuardMiddleware
except Exception:
    try:
        from app.middleware.size_guard import SizeGuardMiddleware
    except Exception:
        SizeGuardMiddleware = None

try:
    from axv_gw.middleware.hooks_metrics import HooksMetricsMiddleware
except Exception:
    try:
        from app.middleware.hooks_metrics import HooksMetricsMiddleware
    except Exception:
        HooksMetricsMiddleware = None


def create_app() -> FastAPI:
    app = FastAPI(title="AXV Gateway")


@app.get("/status")
async def status_alias():
    # Próbujemy użyć istniejącego handlera z front
    try:
        # najczęściej funkcja w routerze nazywa się `status`
        handler = getattr(front, "status", None)
        if handler:
            return await handler()
    except Exception:
        pass
    # Fallback — minimalny status z wersją
    version = os.getenv("GATEWAY_VERSION") or os.getenv("GW_VERSION") or os.getenv("VERSION") or "dev"
    return JSONResponse({"ok": True, "status": {"api": "ok", "version": version}})

    # == build middleware stack ==
    # order: outermost -> innermost (last added is outermost in Starlette)
    if HooksMetricsMiddleware:
        app.add_middleware(HooksMetricsMiddleware)
    if SizeGuardMiddleware:
        app.add_middleware(SizeGuardMiddleware)
    if HMACTimestampGuard:
        app.add_middleware(HMACTimestampGuard)
    if RateLimitMiddleware:
        app.add_middleware(RateLimitMiddleware)
    if RequestLoggingMiddleware:
        app.add_middleware(RequestLoggingMiddleware)

    # routers
    app.include_router(front.router)
    app.include_router(hooks.router)
    app.include_router(internal.router)

    return app


app = create_app()
